<system name="Tu-154B-2: ABSU Calc">

	<channel name="absu_property_update" execrate="4">
		
		<!-- pn-5 selected mode -->
		<switch name="calc/absu/absu_property_update/vor-support/radial-actual">
			<default value="/instrumentation/nav[0]/radials/actual-deg"/>
			<test logic="AND" value="/instrumentation/nav[1]/radials/actual-deg">
				/tu154/instrumentation/pn-5/az-2-cmd ne 0
			</test>
		</switch>
		<switch name="calc/absu/absu_property_update/vor-support/radial-reciprocal">
			<default value="/instrumentation/nav[0]/radials/reciprocal-radial-deg"/>
			<test logic="AND" value="/instrumentation/nav[1]/radials/reciprocal-radial-deg">
				/tu154/instrumentation/pn-5/az-2-cmd ne 0
			</test>
		</switch>
		<switch name="calc/absu/absu_property_update/vor-support/radial-selected">
			<default value="/instrumentation/nav[0]/radials/selected-deg"/>
			<test logic="AND" value="/instrumentation/nav[1]/radials/selected-deg">
				/tu154/instrumentation/pn-5/az-2-cmd ne 0
			</test>
		</switch>
		<switch name="calc/absu/absu_property_update/vor-support/to-flag">
			<default value="/instrumentation/nav[0]/to-flag"/>
			<test logic="AND" value="/instrumentation/nav[1]/to-flag">
				/tu154/instrumentation/pn-5/az-2-cmd ne 0
			</test>
		</switch>


		<!-- VOR support -->
		<switch name="calc/absu/absu_property_update/vor-support/param">
			<default value="calc/absu/absu_property_update/vor-support/radial-actual"/>
			<test logic="AND" value="calc/absu/absu_property_update/vor-support/radial-reciprocal">
				calc/absu/absu_property_update/vor-support/to-flag ne 0
			</test>
		</switch>

		<fcs_function name="calc/absu/absu_property_update/vor-support/param-diff">
			<function>
				<difference>
					<property>calc/absu/absu_property_update/vor-support/param</property>
					<property>calc/absu/absu_property_update/vor-support/radial-selected</property>
				</difference>
			</function>
		</fcs_function>

		<fcs_function name="calc/absu/absu_property_update/vor-support/param-l-180">
			<function>
				<sum>
					<value> 360.0 </value>
					<property>calc/absu/absu_property_update/vor-support/param-diff</property>
				</sum>
			</function>
		</fcs_function>

		<fcs_function name="calc/absu/absu_property_update/vor-support/param-g180">
			<function>
				<difference>
					<value> 360.0 </value>
					<property>calc/absu/absu_property_update/vor-support/param-diff</property>
				</difference>
			</function>
		</fcs_function>

		<switch name="calc/absu/absu_property_update/vor-support/param-res">
			<default value="calc/absu/absu_property_update/vor-support/param-diff"/>
			<test logic="AND" value="calc/absu/absu_property_update/vor-support/param-l-180">
				calc/absu/absu_property_update/vor-support/param-diff lt -180.0
			</test>
			<test logic="AND" value="calc/absu/absu_property_update/vor-support/param-g180">
				calc/absu/absu_property_update/vor-support/param-diff gt 180.0
			</test>
		</switch>

		<fcs_function name="ap/input-heading-delta">
			<function>
				<product>
					<property>calc/absu/absu_property_update/vor-support/param-res</property>
					<sum>
						<value> 1 </value>
						<product>
							<value> -2 </value>
							<property>calc/absu/absu_property_update/vor-support/to-flag</property>
						</product>
					</sum>
				</product>
			</function>
		</fcs_function>


		<!-- Delivery gyro heading to TKS compass system -->
		<fcs_function name="ap/input-heading-gyro-1">
			<function>
				<mod>
					<sum>
						<property>/orientation/heading-deg</property>
						<property>/instrumentation/heading-indicator[0]/offset-deg</property>
						<value> 360.0 </value>
					</sum>
					<value> 360.0 </value>
				</mod>
			</function>
		</fcs_function>
		<fcs_function name="ap/input-heading-gyro-2">
			<function>
				<mod>
					<sum>
						<property>/orientation/heading-deg</property>
						<property>/instrumentation/heading-indicator[1]/offset-deg</property>
						<value> 360.0 </value>
					</sum>
					<value> 360.0 </value>
				</mod>
			</function>
		</fcs_function>

		<!-- PNP -->
		<!-- "Plane" handle -->
		<switch name="ap/input-heading-pnp">
			<default value="/tu154/instrumentation/pnp[0]/plane-deg"/>
			<test logic="AND" value="/tu154/instrumentation/pnp[1]/plane-deg">
				/tu154/switches/pn-5-pnp-selector ne 0
			</test>
		</switch>
		<!-- ZK handle -->
		<switch name="ap/input-heading-zk">
			<default value="/tu154/instrumentation/pnp[0]/heading-deg"/>
			<test logic="AND" value="/tu154/instrumentation/pnp[1]/heading-deg">
				/tu154/switches/zk-selector ne 0
			</test>
		</switch>

		<!-- PKP -->
		<!-- Directors -->
		<switch name="/tu154/instrumentation/pkp[0]/pitch-director">
			<default value="1.0"/>
			<test logic="AND" value="ap/pitch/gs-needle">
				ap/pitch-selector eq 5
				/tu154/switches/pn-5-strelki ne 0
			</test>
			<test logic="AND" value="0.0">
				ap/pitch-selector ne 5
				/tu154/switches/pn-5-strelki ne 0
			</test>
		</switch>
		<switch name="/tu154/instrumentation/pkp[0]/roll-director">
			<default value="1.0"/>
			<test logic="AND" value="ap/ils-out">
				ap/roll-selector eq 5
				/tu154/switches/pn-5-strelki ne 0
			</test>
			<test logic="AND" value="0.0">
				ap/roll-selector ne 5
				/tu154/switches/pn-5-strelki ne 0
			</test>
		</switch>

		<!-- Glideslope -->
		<switch name="calc/absu/absu_glideslope/trigger">
			<default value="0"/>
			<test logic="AND" value="1">
				fcs/flap-pos-deg gt 40.0
				ap/roll-selector eq 5
				ap/pitch-selector ne 5
				/instrumentation/nav[0]/gs-needle-deflection lt 0.2
				/instrumentation/nav[0]/gs-needle-deflection gt 0.0
			</test>
		</switch>

		<!-- Go around procedure -->
		<switch name="calc/absu/absu_start_ga/trigger">
			<default value="0"/>
			<test logic="AND" value="1">
				ap/pitch-selector eq 5
				fcs/throttle-cmd-norm[0] gt 0.9
				/instrumentation/nav[0]/gs-in-range ne 0
			</test>
		</switch>

	</channel>
	
</system>
