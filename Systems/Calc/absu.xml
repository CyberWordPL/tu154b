<system name="Tu-154B-2: ABSU Calc">

	<channel name="absu_property_update" execrate="4">
		
		<!-- pn-5 selected mode -->
		<switch name="calc/absu/absu_property_update/vor-support/radial-actual">
			<default value="/instrumentation/nav[0]/radials/actual-deg"/>
			<test logic="AND" value="/instrumentation/nav[1]/radials/actual-deg">
				/tu154/instrumentation/pn-5/az-2-cmd ne 0
			</test>
		</switch>
		<switch name="calc/absu/absu_property_update/vor-support/radial-reciprocal">
			<default value="/instrumentation/nav[0]/radials/reciprocal-radial-deg"/>
			<test logic="AND" value="/instrumentation/nav[1]/radials/reciprocal-radial-deg">
				/tu154/instrumentation/pn-5/az-2-cmd ne 0
			</test>
		</switch>
		<switch name="calc/absu/absu_property_update/vor-support/radial-selected">
			<default value="/instrumentation/nav[0]/radials/selected-deg"/>
			<test logic="AND" value="/instrumentation/nav[1]/radials/selected-deg">
				/tu154/instrumentation/pn-5/az-2-cmd ne 0
			</test>
		</switch>
		<switch name="calc/absu/absu_property_update/vor-support/to-flag">
			<default value="/instrumentation/nav[0]/to-flag"/>
			<test logic="AND" value="/instrumentation/nav[1]/to-flag">
				/tu154/instrumentation/pn-5/az-2-cmd ne 0
			</test>
		</switch>


		<!-- VOR support -->
		<switch name="calc/absu/absu_property_update/vor-support/param">
			<default value="calc/absu/absu_property_update/vor-support/radial-actual"/>
			<test logic="AND" value="calc/absu/absu_property_update/vor-support/radial-reciprocal">
				calc/absu/absu_property_update/vor-support/to-flag ne 0
			</test>
		</switch>

		<fcs_function name="calc/absu/absu_property_update/vor-support/param-diff">
			<function>
				<difference>
					<property>calc/absu/absu_property_update/vor-support/param</property>
					<property>calc/absu/absu_property_update/vor-support/radial-selected</property>
				</difference>
			</function>
		</fcs_function>

		<fcs_function name="calc/absu/absu_property_update/vor-support/param-l-180">
			<function>
				<sum>
					<value> 360.0 </value>
					<property>calc/absu/absu_property_update/vor-support/param-diff</property>
				</sum>
			</function>
		</fcs_function>

		<fcs_function name="calc/absu/absu_property_update/vor-support/param-g180">
			<function>
				<difference>
					<value> 360.0 </value>
					<property>calc/absu/absu_property_update/vor-support/param-diff</property>
				</difference>
			</function>
		</fcs_function>

		<switch name="calc/absu/absu_property_update/vor-support/param-res">
			<default value="calc/absu/absu_property_update/vor-support/param-diff"/>
			<test logic="AND" value="calc/absu/absu_property_update/vor-support/param-l-180">
				calc/absu/absu_property_update/vor-support/param-diff lt -180.0
			</test>
			<test logic="AND" value="calc/absu/absu_property_update/vor-support/param-g180">
				calc/absu/absu_property_update/vor-support/param-diff gt 180.0
			</test>
		</switch>

		<fcs_function name="ap/input-heading-delta">
			<function>
				<product>
					<property>calc/absu/absu_property_update/vor-support/param-res</property>
					<sum>
						<value> 1 </value>
						<product>
							<value> -2 </value>
							<property>calc/absu/absu_property_update/vor-support/to-flag</property>
						</product>
					</sum>
				</product>
			</function>
		</fcs_function>


		<!-- Delivery gyro heading to TKS compass system -->
		<fcs_function name="ap/input-heading-gyro-1">
			<function>
				<mod>
					<sum>
						<property>/orientation/heading-deg</property>
						<property>/instrumentation/heading-indicator[0]/offset-deg</property>
						<value> 360.0 </value>
					</sum>
					<value> 360.0 </value>
				</mod>
			</function>
		</fcs_function>
		<fcs_function name="ap/input-heading-gyro-2">
			<function>
				<mod>
					<sum>
						<property>/orientation/heading-deg</property>
						<property>/instrumentation/heading-indicator[1]/offset-deg</property>
						<value> 360.0 </value>
					</sum>
					<value> 360.0 </value>
				</mod>
			</function>
		</fcs_function>

		<!-- PNP -->
		<!-- "Plane" handle -->
		<switch name="ap/input-heading-pnp">
			<default value="/tu154/instrumentation/pnp[0]/plane-deg"/>
			<test logic="AND" value="/tu154/instrumentation/pnp[1]/plane-deg">
				/tu154/switches/pn-5-pnp-selector ne 0
			</test>
		</switch>
		<!-- ZK handle -->
		<switch name="ap/input-heading-zk">
			<default value="/tu154/instrumentation/pnp[0]/heading-deg"/>
			<test logic="AND" value="/tu154/instrumentation/pnp[1]/heading-deg">
				/tu154/switches/zk-selector ne 0
			</test>
		</switch>

		<!-- PKP -->
		<!-- Directors -->
		<switch name="/tu154/instrumentation/pkp[0]/pitch-director">
			<default value="1.0"/>
			<test logic="AND" value="ap/pitch/gs-needle">
				ap/pitch-selector eq 5
				/tu154/switches/pn-5-strelki ne 0
			</test>
			<test logic="AND" value="0.0">
				ap/pitch-selector ne 5
				/tu154/switches/pn-5-strelki ne 0
			</test>
		</switch>
		<switch name="/tu154/instrumentation/pkp[0]/roll-director">
			<default value="1.0"/>
			<test logic="AND" value="ap/ils-out">
				ap/roll-selector eq 5
				/tu154/switches/pn-5-strelki ne 0
			</test>
			<test logic="AND" value="0.0">
				ap/roll-selector ne 5
				/tu154/switches/pn-5-strelki ne 0
			</test>
		</switch>

		<!-- Glideslope -->
		<switch name="calc/absu/absu_glideslope/trigger">
			<default value="0"/>
			<test logic="AND" value="1">
				fcs/flap-pos-deg gt 40.0
				ap/roll-selector eq 5
				ap/pitch-selector ne 5
				/instrumentation/nav[0]/gs-needle-deflection lt 0.2
				/instrumentation/nav[0]/gs-needle-deflection gt 0.0
			</test>
			<test logic="AND" value="1">
				/tu154/buttons/pn-5-glideslope eq 1
			</test>
		</switch>

		<!-- Go around procedure -->
		<switch name="calc/absu/absu_start_ga/trigger">
			<default value="0"/>
			<test logic="AND" value="1">
				ap/pitch-selector eq 5
				fcs/throttle-cmd-norm[0] gt 0.9
				/instrumentation/nav[0]/gs-in-range ne 0
			</test>
		</switch>

	</channel>


	<!--********************* Stabilization channels *********************-->
	<channel name="Stabilization channels">

		<switch name="ap/roll-hold">
			<default value="0"/>
			<test logic="AND" value="0">
				/tu154/systems/absu/serviceable eq 1
				/tu154/buttons/yoke-disc eq 1
			</test>
			<test logic="AND" value="1">
				/tu154/systems/absu/serviceable eq 1
				/tu154/switches/pu-46-kren eq 1
				ap/pitch-hold eq 1
			</test>
			<test logic="AND" value="1">
				/tu154/systems/absu/serviceable eq 1
				/tu154/switches/pu-46-kren eq 1
				/tu154/buttons/pu-46-stab eq 1
			</test>
		</switch>

		<switch name="ap/pitch-hold">
			<default value="0"/>
			<test logic="AND" value="0">
				/tu154/systems/absu/serviceable eq 1
				/tu154/buttons/yoke-disc eq 1
			</test>
			<test logic="AND" value="1">
				/tu154/systems/absu/serviceable eq 1
				/tu154/switches/pu-46-tang eq 1
				ap/roll-hold eq 1
			</test>
			<test logic="AND" value="1">
				/tu154/systems/absu/serviceable eq 1
				/tu154/switches/pu-46-tang eq 1
				/tu154/buttons/pu-46-stab eq 1
			</test>
		</switch>

	</channel>


	<!--********************* ABSU modes *********************-->
	<channel name="absu_modes" execrate="4">

		<switch name="ap/roll-selector">
			<default value="ap/roll-selector"/>
			<test logic="AND" value="1">
				/tu154/systems/absu/serviceable eq 0
			</test>
			<test logic="AND" value="1">
				/tu154/systems/absu/serviceable eq 1
				/tu154/buttons/pu-46-stab eq 1
			</test>
			<test logic="AND" value="1">
				/tu154/systems/absu/serviceable eq 1
				/tu154/buttons/pn-5-sbros eq 1
			</test>
			<!--<test logic="AND" value="1">
				/tu154/systems/absu/serviceable eq 1
				ap/roll-hold eq 1
				ap/roll-hold ne calc/absu/hold-roll/prev
			</test>-->
			<test logic="AND" value="1">
				/tu154/systems/absu/serviceable eq 1
				/tu154/switches/pn-5-posadk eq 1
				/tu154/switches/pn-5-navigac eq 0
				calc/absu/absu_start_ga/trigger eq 1
			</test>
			<test logic="AND" value="2">
				/tu154/systems/absu/serviceable eq 1
				/tu154/buttons/pn-5-zk eq 1
			</test>
		</switch>

		<switch name="ap/pitch-selector">
			<default value="ap/pitch-selector"/>
			<test logic="AND" value="1">
				/tu154/systems/absu/serviceable eq 0
			</test>
			<test logic="AND" value="1">
				/tu154/systems/absu/serviceable eq 1
				/tu154/buttons/pu-46-stab eq 1
			</test>
			<test logic="AND" value="1">
				/tu154/systems/absu/serviceable eq 1
				/tu154/buttons/pn-5-sbros eq 1
			</test>
			<!--<test logic="AND" value="1">
				/tu154/systems/absu/serviceable eq 1
				ap/pitch-hold eq 1
				ap/pitch-hold ne calc/absu/hold-pitch/prev
			</test>-->
			<test logic="AND" value="5">
				/tu154/systems/absu/serviceable eq 1
				/tu154/switches/pn-5-posadk eq 1
				/tu154/switches/pn-5-navigac eq 0
				calc/absu/absu_glideslope/trigger eq 1
			</test>
			<test logic="AND" value="6">
				/tu154/systems/absu/serviceable eq 1
				/tu154/switches/pn-5-posadk eq 1
				/tu154/switches/pn-5-navigac eq 0
				calc/absu/absu_start_ga/trigger eq 1
			</test>
		</switch>
		
	</channel>


	<!--************************* ABSU alarm **************************-->
	<channel name="ABSU alarm">
		<switch name="calc/absu/absu-alarm">
			<default value="calc/absu/absu-alarm"/>
			<test logic="AND" value="1">
				/tu154/systems/absu/serviceable eq 1
				ap/roll-hold eq 0
				ap/roll-hold ne calc/absu/hold-roll/prev
			</test>
			<test logic="AND" value="1">
				/tu154/systems/absu/serviceable eq 1
				ap/pitch-hold eq 0
				ap/pitch-hold ne calc/absu/hold-pitch/prev
			</test>
			<test logic="AND" value="1">
				/tu154/systems/absu/serviceable ne calc/absu/serviceable/prev
			</test>
		</switch>
	</channel>


	<!--********************* Indicators *********************-->
	<channel name="PU-46 PN-5 indicators" execrate="6">

		<!-- Roll blanker -->
		<switch name="/tu154/instrumentation/pn-5/heading-state">
			<default value="0"/>
			<test logic="AND" value="1">
				/tu154/systems/absu/serviceable eq 1
				ap/roll-hold eq 0
			</test>
			<test logic="AND" value="2">
				/tu154/systems/absu/serviceable eq 1
				ap/roll-hold eq 1
			</test>
		</switch>
		<!-- Pitch blanker -->
		<switch name="/tu154/instrumentation/pn-5/pitch-state">
			<default value="0"/>
			<test logic="AND" value="1">
				/tu154/systems/absu/serviceable eq 1
				ap/pitch-hold eq 0
			</test>
			<test logic="AND" value="2">
				/tu154/systems/absu/serviceable eq 1
				ap/pitch-hold eq 1
			</test>
		</switch>

		<!-- Stab active -->
		<switch name="/tu154/instrumentation/pu-46/stab">
			<default value="0"/>
			<test logic="AND" value="1">
				/tu154/systems/absu/serviceable eq 1
				ap/roll-hold eq 1
			</test>
			<test logic="AND" value="1">
				/tu154/systems/absu/serviceable eq 1
				ap/pitch-hold eq 1
			</test>
		</switch>

		<!-- Sbros / Wing level -->
		<switch name="/tu154/instrumentation/pn-5/sbros">
			<default value="0"/>
			<test logic="AND" value="1">
				/tu154/systems/absu/serviceable eq 1
				ap/roll-selector eq 0
			</test>
			<test logic="AND" value="1">
				/tu154/systems/absu/serviceable eq 1
				ap/roll-selector eq 1
			</test>
		</switch>
		<!-- ZK / HDG select -->
		<switch name="/tu154/instrumentation/pn-5/zk">
			<default value="0"/>
			<test logic="AND" value="1">
				/tu154/systems/absu/serviceable eq 1
				ap/roll-selector eq 2
			</test>
		</switch>
		<!-- AZ-I / VOR 1 -->
		<switch name="/tu154/instrumentation/pn-5/az-1">
			<default value="0"/>
			<test logic="AND" value="1">
				/tu154/systems/absu/serviceable eq 1
				ap/roll-selector eq 3
				/tu154/instrumentation/pn-5/az-1-cmd eq 1
			</test>
		</switch>
		<!-- AZ-I / VOR 1 -->
		<switch name="/tu154/instrumentation/pn-5/az-2">
			<default value="0"/>
			<test logic="AND" value="1">
				/tu154/systems/absu/serviceable eq 1
				ap/roll-selector eq 3
				/tu154/instrumentation/pn-5/az-2-cmd eq 1
			</test>
		</switch>
		<!-- NVU -->
		<switch name="/tu154/instrumentation/pn-5/nvu">
			<default value="0"/>
			<test logic="AND" value="1">
				/tu154/systems/absu/serviceable eq 1
				ap/roll-selector eq 4
			</test>
		</switch>
		<!-- Zahod / ILS LOC -->
		<switch name="/tu154/instrumentation/pn-5/zahod">
			<default value="0"/>
			<test logic="AND" value="1">
				/tu154/systems/absu/serviceable eq 1
				ap/roll-selector eq 5
			</test>
		</switch>
		<!-- Glideslope -->
		<switch name="/tu154/instrumentation/pn-5/gliss">
			<default value="0"/>
			<test logic="AND" value="1">
				/tu154/systems/absu/serviceable eq 1
				ap/pitch-selector eq 5
			</test>
		</switch>
		
		<!-- Alt stab -->
		<switch name="/tu154/instrumentation/pu-46/h">
			<default value="0"/>
			<test logic="AND" value="1">
				/tu154/systems/absu/serviceable eq 1
				ap/pitch-selector eq 2
			</test>
		</switch>
		<!-- IAS stab -->
		<switch name="/tu154/instrumentation/pu-46/v">
			<default value="0"/>
			<test logic="AND" value="1">
				/tu154/systems/absu/serviceable eq 1
				ap/pitch-selector eq 3
			</test>
		</switch>
		<!-- Mach stab -->
		<switch name="/tu154/instrumentation/pu-46/m">
			<default value="0"/>
			<test logic="AND" value="1">
				/tu154/systems/absu/serviceable eq 1
				ap/pitch-selector eq 4
			</test>
		</switch>
		

	</channel>


	<channel name="Pilots panel indicators" execrate="6">

		<!-- Hdg stab / Wing level -->
		<switch name="/tu154/systems/electrical/indicators/stab-heading">
			<default value="0"/>
			<test logic="AND" value="1">
				/tu154/systems/absu/serviceable eq 1
				ap/roll-selector eq 1
				ap/roll-hold eq 1
			</test>
		</switch>
		<!-- ZK / HDG select -->
		<switch name="/tu154/systems/electrical/indicators/zk">
			<default value="0"/>
			<test logic="AND" value="1">
				/tu154/systems/absu/serviceable eq 1
				ap/roll-selector eq 2
				ap/roll-hold eq 1
			</test>
		</switch>
		<!-- VOR -->
		<switch name="/tu154/systems/electrical/indicators/vor">
			<default value="0"/>
			<test logic="AND" value="1">
				/tu154/systems/absu/serviceable eq 1
				ap/roll-selector eq 3
				ap/roll-hold eq 1
			</test>
		</switch>
		<!-- NVU -->
		<switch name="/tu154/systems/electrical/indicators/nvu">
			<default value="0"/>
			<test logic="AND" value="1">
				/tu154/systems/absu/serviceable eq 1
				ap/roll-selector eq 4
				ap/roll-hold eq 1
			</test>
		</switch>
		<!-- Hdg / ILS LOC -->
		<switch name="/tu154/systems/electrical/indicators/heading">
			<default value="0"/>
			<test logic="AND" value="1">
				/tu154/systems/absu/serviceable eq 1
				ap/roll-selector eq 5
				ap/roll-hold eq 1
			</test>
		</switch>

		<!-- Pitch hold -->
		<switch name="/tu154/systems/electrical/indicators/stab-pitch">
			<default value="0"/>
			<test logic="AND" value="1">
				/tu154/systems/absu/serviceable eq 1
				ap/pitch-selector eq 1
				ap/pitch-hold eq 1
			</test>
		</switch>
		<!-- Alt hold -->
		<switch name="/tu154/systems/electrical/indicators/stab-h">
			<default value="0"/>
			<test logic="AND" value="1">
				/tu154/systems/absu/serviceable eq 1
				ap/pitch-selector eq 2
				ap/pitch-hold eq 1
			</test>
		</switch>
		<!-- IAS hold -->
		<switch name="/tu154/systems/electrical/indicators/stab-v">
			<default value="0"/>
			<test logic="AND" value="1">
				/tu154/systems/absu/serviceable eq 1
				ap/pitch-selector eq 3
				ap/pitch-hold eq 1
			</test>
		</switch>
		<!-- Mach hold -->
		<switch name="/tu154/systems/electrical/indicators/stab-m">
			<default value="0"/>
			<test logic="AND" value="1">
				/tu154/systems/absu/serviceable eq 1
				ap/pitch-selector eq 4
				ap/pitch-hold eq 1
			</test>
		</switch>
		<!-- Glideslope -->
		<switch name="/tu154/systems/electrical/indicators/glideslope">
			<default value="0"/>
			<test logic="AND" value="1">
				/tu154/systems/absu/serviceable eq 1
				ap/pitch-selector eq 5
				ap/pitch-hold eq 1
			</test>
		</switch>
		<!-- Reject / Go Around -->
		<switch name="/tu154/systems/electrical/indicators/reject">
			<default value="0"/>
			<test logic="AND" value="1">
				/tu154/systems/absu/serviceable eq 1
				ap/pitch-selector eq 6
				ap/pitch-hold eq 1
			</test>
		</switch>

	</channel>


	<!--************************* Update prevous values *************************-->
	<channel name="Listeners updater">
		<pure_gain name="calc/absu/hold-roll/prev">
			<input>ap/roll-hold</input>
			<gain>1.0</gain>
		</pure_gain>
		<pure_gain name="calc/absu/hold-pitch/prev">
			<input>ap/pitch-hold</input>
			<gain>1.0</gain>
		</pure_gain>
		<pure_gain name="calc/absu/serviceable/prev">
			<input>/tu154/systems/absu/serviceable</input>
			<gain>1.0</gain>
		</pure_gain>
	</channel>
	
</system>
